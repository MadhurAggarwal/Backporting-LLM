
    The upstream patch in Standard Git Diff format is:
    <Patch>
From f182429e5b1fc034050510da20c93256c4fa9652 Mon Sep 17 00:00:00 2001
From: Patrick Griffis <pgriffis@igalia.com>
Date: Sat, 16 Nov 2024 12:07:30 -0600
Subject: [PATCH] Fix heap buffer overflow in soup_content_sniffer_sniff

Co-Author: Ar Jun <pkillarjun@protonmail.com>
---
 libsoup/content-sniffer/soup-content-sniffer.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/libsoup/content-sniffer/soup-content-sniffer.c b/libsoup/content-sniffer/soup-content-sniffer.c
index de0985eac..b62e48889 100644
--- a/libsoup/content-sniffer/soup-content-sniffer.c
+++ b/libsoup/content-sniffer/soup-content-sniffer.c
@@ -532,7 +532,7 @@ sniff_unknown (SoupContentSniffer *sniffer, GBytes *buffer,
                guint index_stream = 0;
                guint index_pattern = 0;
                gboolean skip_row = FALSE;
 
-			while ((index_stream < resource_length) &&
+			while ((index_stream < resource_length - 1) &&
                    (index_pattern <= type_row->pattern_length)) {
                    /* Skip insignificant white space ("WS" in the spec) */
                    if (type_row->pattern[index_pattern] == ' ') {
-- 
GitLab
    <end>

    The downstream file code has diverged from upstream.
    Here, the line content in the diverged file is:
528: 		if (type_row->has_ws) {
529: 			guint index_stream = 0;
530: 			guint index_pattern = 0;
531: 			gboolean skip_row = FALSE;
532: 
533: 			while ((index_stream < resource_length) &&
534: 			       (index_pattern <= type_row->pattern_length)) {
535: 				/* Skip insignificant white space ("WS" in the spec) */
536: 				if (type_row->pattern[index_pattern] == ' ') {
537: 					if (resource[index_stream] == '\x09' ||
538: 					    resource[index_stream] == '\x0a' ||
539: 					    resource[index_stream] == '\x0c' ||
540: 					    resource[index_stream] == '\x0d' ||
541: 					    resource[index_stream] == '\x20')
542: 						index_stream++;
543: 					else
544: 						index_pattern++;
545: 				} else {
546: 					if ((type_row->mask[index_pattern] & resource[index_stream]) != type_row->pattern[index_pattern]) {
547: 						skip_row = TRUE;
548: 						break;
549: 					}
550: 				}
551: 				index_stream++;
552: 				index_pattern++;
553: 			}
554: 
555: 			if (skip_row)
556: 				continue;
557: 		}

    TASK:
    The upstream patch uses different whitespace, tabs etc. than the downstream code
    Also some lines could be missing / extra in the new file code, from when the patch was created.
    So, update the patch to the new line content.

    Ensure that the patch logic is NOT changed.
    Ensure that line content like newlines, tabs, whitespace etc matches the downstream file code.

    Do NOT give any extra tokens like diff ``` or <patch>.
    Only output the final patch in STANDARD GIT diff format.
