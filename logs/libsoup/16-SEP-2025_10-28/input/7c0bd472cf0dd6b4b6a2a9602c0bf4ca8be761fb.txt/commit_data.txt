commit 7c0bd472cf0dd6b4b6a2a9602c0bf4ca8be761fb
Author: Max Schmitt <max@schmitt.mx>
Date:   Thu Apr 11 11:00:27 2024 +0200

    fix(cookies): limit Max-Age to 1 year

diff --git a/libsoup/cookies/soup-cookie.c b/libsoup/cookies/soup-cookie.c
index 7c41b1dd..112a61ae 100644
--- a/libsoup/cookies/soup-cookie.c
+++ b/libsoup/cookies/soup-cookie.c
@@ -168,6 +168,8 @@ parse_date (const char **val_p)
 	return date;
 }
 
+#define MAX_AGE_CAP_IN_SECONDS 31536000  // 1 year
+
 static SoupCookie *
 parse_one_cookie (const char *header, GUri *origin)
 {
@@ -224,6 +226,8 @@ parse_one_cookie (const char *header, GUri *origin)
 			if (!*mae) {
 				if (max_age < 0)
 					max_age = 0;
+				if (max_age > MAX_AGE_CAP_IN_SECONDS)
+					max_age = MAX_AGE_CAP_IN_SECONDS;
 				soup_cookie_set_max_age (cookie, max_age);
 			}
 			g_free (max_age_str);
diff --git a/tests/cookies-test.c b/tests/cookies-test.c
index cafa26e4..9300697e 100644
--- a/tests/cookies-test.c
+++ b/tests/cookies-test.c
@@ -434,6 +434,28 @@ do_cookies_parsing_nopath_nullorigin (void)
 	soup_cookie_free (cookie);
 }
 
+static void
+do_cookies_parsing_max_age_int32_overflow (void)
+{
+	SoupCookie *cookie = soup_cookie_parse ("NAME=VALUE; Max-Age=2147483648", NULL);
+	g_assert_nonnull (cookie);
+	g_assert_cmpstr ("/", ==, soup_cookie_get_path (cookie));
+	g_assert_true (soup_cookie_get_expires (cookie) != NULL);
+	g_assert_true (g_date_time_to_unix (soup_cookie_get_expires (cookie)) > time (NULL));
+	soup_cookie_free (cookie);
+}
+
+static void
+do_cookies_parsing_max_age_long_overflow (void)
+{
+	SoupCookie *cookie = soup_cookie_parse ("NAME=VALUE; Max-Age=99999999999999999999999999999999999", NULL);
+	g_assert_nonnull (cookie);
+	g_assert_cmpstr ("/", ==, soup_cookie_get_path (cookie));
+	g_assert_true (soup_cookie_get_expires (cookie) != NULL);
+	g_assert_true (g_date_time_to_unix (soup_cookie_get_expires (cookie)) > time (NULL));
+	soup_cookie_free (cookie);
+}
+
 static void
 do_cookies_equal_nullpath (void)
 {
@@ -655,6 +677,8 @@ main (int argc, char **argv)
 	g_test_add_func ("/cookies/accept-policy-subdomains", do_cookies_subdomain_policy_test);
 	g_test_add_func ("/cookies/parsing", do_cookies_parsing_test);
 	g_test_add_func ("/cookies/parsing/no-path-null-origin", do_cookies_parsing_nopath_nullorigin);
+	g_test_add_func ("/cookies/parsing/max-age-int32-overflow", do_cookies_parsing_max_age_int32_overflow);
+	g_test_add_func ("/cookies/parsing/max-age-long-overflow", do_cookies_parsing_max_age_long_overflow);
 	g_test_add_func ("/cookies/parsing/equal-nullpath", do_cookies_equal_nullpath);
 	g_test_add_func ("/cookies/parsing/control-characters", do_cookies_parsing_control_characters);
 	g_test_add_func ("/cookies/get-cookies/empty-host", do_get_cookies_empty_host_test);