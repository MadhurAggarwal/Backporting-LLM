commit a8bad1ae13df5b865b961410ef134574a0dfb52b
Author: Vitaly Dyachkov <vitaly@igalia.com>
Date:   Fri Feb 2 15:25:24 2024 +0100

    soup_multipart_input_stream_next_part: return NULL when EOF is reached
    
    Fixes #372

diff --git a/libsoup/soup-multipart-input-stream.c b/libsoup/soup-multipart-input-stream.c
index 99999ea1..5bbd4bed 100644
--- a/libsoup/soup-multipart-input-stream.c
+++ b/libsoup/soup-multipart-input-stream.c
@@ -376,7 +376,7 @@ soup_multipart_input_stream_read_headers (SoupMultipartInputStream  *multipart,
 							    /* blocking */ TRUE, &got_lf, cancellable, error);
 
 		if (nread <= 0)
-			break;
+			return FALSE;
 
 		g_byte_array_append (priv->meta_buf, read_buf, nread);
 
@@ -468,6 +468,9 @@ soup_multipart_input_stream_new (SoupMessage  *msg,
  * the part; a new call to this function should be done at that point,
  * to obtain the next part.
  *
+ * @error will only be set if an error happens during a read, %NULL
+ * is a valid return value otherwise.
+ *
  * Returns: (nullable) (transfer full): a new #GInputStream, or
  *   %NULL if there are no more parts
  */
diff --git a/tests/multipart-test.c b/tests/multipart-test.c
index 8c80265e..2c0e7e96 100644
--- a/tests/multipart-test.c
+++ b/tests/multipart-test.c
@@ -56,7 +56,7 @@ const char *payload = \
 	"Content-Type: text/css\r\n" \
 	"\r\n" \
 	"#soup { background-color: black; }" \
-        "\r\n--cut-here--";
+	"\r\n--cut-here\r\n"; /* Tests missing termination .*/
 
 static void
 server_callback (SoupServer        *server,