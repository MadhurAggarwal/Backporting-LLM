commit b4eea51fc946fd553d19cf8b40ef48099559e53f
Author: Patrick Griffis <pgriffis@igalia.com>
Date:   Wed Mar 19 12:14:29 2025 -0500

    connection: Avoid calling disconnect twice
    
    Reproducing this was unclear but in the case a connection that was
    already in the process of disconnection, is set to not in use, it
    should do nothing.
    
    Closes #366

diff --git a/libsoup/soup-connection.c b/libsoup/soup-connection.c
index 9100f8c9..7e9b0272 100644
--- a/libsoup/soup-connection.c
+++ b/libsoup/soup-connection.c
@@ -1186,6 +1186,9 @@ soup_connection_set_in_use (SoupConnection *conn,
         if (g_atomic_int_dec_and_test (&priv->in_use)) {
                 clear_proxy_msg (conn);
 
+                if (soup_connection_get_state (conn) == SOUP_CONNECTION_DISCONNECTED)
+                        return;
+
                 if (soup_connection_is_reusable (conn))
                         soup_connection_set_state (conn, SOUP_CONNECTION_IDLE);
                 else