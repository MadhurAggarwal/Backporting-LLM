commit 6adc0e3eb74c257ed4e2a23eb4b2774fdb0d67be
Author: Ignacio Casal Quinteiro <qignacio@amazon.com>
Date:   Wed Sep 11 11:52:11 2024 +0200

    websocket: process the frame as soon as we read data
    
    Otherwise we can enter in a read loop because we were not
    validating the data until the all the data was read.
    
    Fixes #391

diff --git a/libsoup/websocket/soup-websocket-connection.c b/libsoup/websocket/soup-websocket-connection.c
index a1a73047..a1448134 100644
--- a/libsoup/websocket/soup-websocket-connection.c
+++ b/libsoup/websocket/soup-websocket-connection.c
@@ -1199,9 +1199,9 @@ soup_websocket_connection_read (SoupWebsocketConnection *self)
 		}
 
 		priv->incoming->len = len + count;
-	} while (count > 0);
 
-	process_incoming (self);
+		process_incoming (self);
+	} while (count > 0 && !priv->close_sent && !priv->io_closing);
 
 	if (end) {
 		if (!priv->close_sent || !priv->close_received) {